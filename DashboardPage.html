<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울시 제설 통합 관제 대시보드</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans KR', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }, // Darker shades
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Dragging Styles */
        .dragging { opacity: 0.5; border: 2px dashed #3b82f6; }
        
        /* Map Drop Zone Highlight */
        .map-drag-over { border: 4px solid #3b82f6; box-sizing: border-box; }

        /* KPI Cards Hover Effect */
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }

        /* Accordion Transition */
        .team-content { transition: max-height 0.3s ease-out; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 h-screen flex flex-col overflow-hidden">

    <!-- 1. Top Navigation -->
    <header class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 h-14 flex items-center justify-between px-5 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="bg-brand-600 text-white p-1.5 rounded-lg">
                <i class="fa-solid fa-shield-halved text-sm"></i>
            </div>
            <h1 class="text-base font-bold tracking-tight">서울시 제설 통합 관제 <span class="text-[10px] font-normal text-slate-500 dark:text-slate-400 ml-1">Admin</span></h1>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- Role Switcher -->
            <div class="hidden md:flex items-center bg-slate-100 dark:bg-slate-700 rounded-full px-1 p-0.5">
                <button class="px-3 py-0.5 text-[10px] font-bold bg-white dark:bg-slate-600 rounded-full shadow-sm text-slate-800 dark:text-white transition-all">관리자</button>
                <button class="px-3 py-0.5 text-[10px] font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 transition-all">현장</button>
            </div>
            
            <div class="h-4 w-px bg-slate-200 dark:bg-slate-600 mx-1"></div>

            <!-- Dark Mode Toggle -->
            <button onclick="toggleDarkMode()" class="text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 p-1.5 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-brand-500">
                <i class="fa-solid fa-moon text-xs dark:hidden"></i>
                <i class="fa-solid fa-sun text-xs hidden dark:block text-amber-400"></i>
            </button>
            
            <!-- User Profile -->
            <div class="flex items-center gap-2 cursor-pointer">
                <div class="w-7 h-7 rounded-full bg-slate-300 dark:bg-slate-600 flex items-center justify-center text-[10px] font-bold">관리</div>
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="flex-1 flex flex-col p-3 gap-3 overflow-hidden">
        
        <!-- 2. Top Section: KPI Metrics (Height fixed to h-40, compact internal elements) -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-3 h-40 shrink-0">
            <!-- Completion Rate -->
            <div class="kpi-card bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-3 flex flex-col relative overflow-hidden">
                <h3 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">실시간 작업 완료율</h3>
                <div class="flex-1 flex items-center justify-between">
                    <!-- Chart Size Reduced -->
                    <div class="w-20 h-20">
                        <canvas id="chartCompletion"></canvas>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-2xl font-bold text-slate-800 dark:text-white">72%</div>
                        <div class="text-[10px] text-emerald-500 font-medium mt-0.5">
                            <i class="fa-solid fa-arrow-trend-up"></i> +15%
                        </div>
                        <div class="text-[9px] text-slate-400 mt-0.5">목표: 90%</div>
                    </div>
                </div>
            </div>

            <!-- Cost Chart (Compact vertical fit) -->
            <div class="kpi-card bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-3 flex flex-col justify-between">
                <div class="flex justify-between items-end mb-1">
                    <h3 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase">투입 예산</h3>
                    <span class="text-[10px] font-bold text-brand-600 dark:text-brand-400">135 / 150 (M)</span>
                </div>
                <!-- Max height constraint for chart container -->
                <div class="relative w-full h-16 flex items-center justify-center">
                     <canvas id="chartCost"></canvas>
                </div>
                <div class="mt-1 text-[9px] text-center text-slate-400">
                    잔여: <span class="font-bold text-slate-600 dark:text-slate-300">1,500만원</span> (집행률 90%)
                </div>
            </div>

            <!-- Government Compliance -->
            <div class="kpi-card bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-3 flex flex-col items-center justify-center relative">
                <div class="absolute top-3 left-3 text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase">기준 준수율</div>
                <div class="w-28 h-14 mt-2 relative">
                    <canvas id="chartCompliance"></canvas>
                    <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 text-base font-bold dark:text-white">95/100</div>
                </div>
                <p class="text-[9px] text-slate-400 mt-1 text-center">행안부 가이드라인</p>
                <span class="bg-emerald-100 text-emerald-700 text-[9px] px-2 py-0.5 rounded-full font-bold mt-1 dark:bg-emerald-900 dark:text-emerald-300">적합</span>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-rows-2 gap-2 h-full">
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 px-4 flex items-center justify-between">
                    <div class="py-1">
                        <div class="text-[9px] text-slate-500 dark:text-slate-400">가동 장비</div>
                        <div class="text-lg font-bold text-brand-600 dark:text-brand-400 leading-tight">142 <span class="text-[9px] text-slate-400 font-normal">/ 150</span></div>
                    </div>
                    <i class="fa-solid fa-truck-plow text-xl text-slate-200 dark:text-slate-600"></i>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 px-4 flex items-center justify-between">
                    <div class="py-1">
                        <div class="text-[9px] text-slate-500 dark:text-slate-400">현장 인력</div>
                        <div class="text-lg font-bold text-brand-600 dark:text-brand-400 leading-tight">385 <span class="text-[9px] text-slate-400 font-normal">명</span></div>
                    </div>
                    <i class="fa-solid fa-users-gear text-xl text-slate-200 dark:text-slate-600"></i>
                </div>
            </div>
        </section>

        <!-- 3. Middle Section: Staff Management & Map -->
        <section class="flex-1 flex gap-3 min-h-0">
            
            <!-- Staff List (Team Accordion & Draggable) -->
            <div class="w-1/3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col">
                <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold text-xs dark:text-white">현장 작업자 (팀별)</h2>
                    <div class="flex gap-1">
                        <input type="text" placeholder="이름 검색..." class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded px-2 py-0.5 text-[10px] focus:outline-none focus:border-brand-500 dark:text-white w-20">
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-2 custom-scrollbar" id="teamContainer">
                    <!-- Teams will be rendered here by JS -->
                </div>
                
                <div class="p-2 bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 text-[9px] text-slate-400 text-center">
                    <i class="fa-regular fa-hand-pointer"></i> 팀원을 펼쳐 아이콘을 지도로 드래그하세요.
                </div>
            </div>

            <!-- Mini Map Integration -->
            <div class="flex-1 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col relative overflow-hidden group">
                <div class="absolute top-3 right-3 z-[400] bg-white/90 dark:bg-slate-800/90 backdrop-blur px-2 py-1 rounded shadow border border-slate-200 dark:border-slate-600 text-[10px] font-bold dark:text-white">
                    <i class="fa-solid fa-map-location-dot mr-1 text-brand-500"></i> 관제맵
                </div>
                <!-- Map Container -->
                <div id="adminMap" class="w-full h-full z-0"></div>
                
                <!-- Drag Overlay (Visible when dragging) -->
                <div id="mapDropOverlay" class="absolute inset-0 bg-brand-500/20 z-[1000] hidden flex items-center justify-center border-4 border-brand-500 border-dashed m-2 rounded-xl pointer-events-none">
                    <div class="bg-brand-600 text-white px-4 py-2 rounded-full font-bold shadow-lg animate-bounce">
                        <i class="fa-solid fa-thumbtack mr-2"></i>여기에 놓아서 구역 할당
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Bottom Section: Notifications (Collapsible) -->
        <section class="h-28 shrink-0 bg-slate-800 dark:bg-black text-white rounded-lg shadow-lg flex flex-col overflow-hidden border-l-4 border-amber-500">
            <div class="px-3 py-1.5 bg-slate-700/50 flex justify-between items-center border-b border-slate-600">
                <h3 class="text-[10px] font-bold text-amber-400 flex items-center gap-1.5">
                    <span class="relative flex h-1.5 w-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-amber-500"></span>
                    </span>
                    실시간 긴급 알림
                </h3>
                <button class="text-[10px] text-slate-400 hover:text-white">지우기</button>
            </div>
            <div class="flex-1 overflow-y-auto p-1.5 space-y-1.5 custom-scrollbar" id="notificationPanel">
                <!-- Log Items -->
                <div class="flex items-start gap-2 text-[10px] p-1.5 hover:bg-white/5 rounded transition-colors cursor-pointer">
                    <span class="text-slate-400 font-mono whitespace-nowrap">01:05:22</span>
                    <span class="bg-red-500/20 text-red-300 px-1 py-0.5 rounded text-[9px] border border-red-500/30 font-bold">긴급</span>
                    <span>종로구 평창동 12-4 급경사 구간 제설제 부족 요청. (담당: 박민수)</span>
                    <button class="ml-auto bg-slate-700 hover:bg-slate-600 px-1.5 py-0.5 rounded text-[9px]">승인</button>
                </div>
                <div class="flex items-start gap-2 text-[10px] p-1.5 hover:bg-white/5 rounded transition-colors cursor-pointer">
                    <span class="text-slate-400 font-mono whitespace-nowrap">01:02:15</span>
                    <span class="bg-blue-500/20 text-blue-300 px-1 py-0.5 rounded text-[9px] border border-blue-500/30 font-bold">정보</span>
                    <span>기상청 대설주의보 발효 (적설량 5cm 예상). 전 인원 비상 대기 전환.</span>
                </div>
            </div>
        </section>

    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- 1. Charts Initialization ---
        
        // Completion Rate Pie Chart
        new Chart(document.getElementById('chartCompletion'), {
            type: 'doughnut',
            data: {
                labels: ['완료', '진행중', '대기'],
                datasets: [{
                    data: [72, 20, 8],
                    backgroundColor: ['#10B981', '#3b82f6', '#cbd5e1'],
                    borderWidth: 0, hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
        });

        // Compliance Gauge
        new Chart(document.getElementById('chartCompliance'), {
            type: 'doughnut',
            data: {
                labels: ['준수', '미달'],
                datasets: [{
                    data: [95, 5],
                    backgroundColor: ['#10B981', '#e2e8f0'],
                    borderWidth: 0, circumference: 180, rotation: 270,
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        });

        // Cost Chart (Single Bar for Plan vs Actual)
        new Chart(document.getElementById('chartCost'), {
            type: 'bar',
            data: {
                labels: ['예산 집행'],
                datasets: [
                    { label: '계획', data: [150], backgroundColor: '#94a3b8', borderRadius: 3, barPercentage: 0.5 },
                    { label: '실제', data: [135], backgroundColor: '#3b82f6', borderRadius: 3, barPercentage: 0.5 }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 6, font: { size: 9 }, padding: 4 } } },
                scales: { x: { beginAtZero: true, grid: { display: false }, ticks: { display: false } }, y: { display: false } }
            }
        });


        // --- 2. Staff Management (Grouped by Team) ---
        
        // 현실적인 이름과 팀 구조 데이터 (대폭 확장)
        const teamsData = [
            {
                id: 't1', name: '종로_제설_1팀', area: '평창동/구기동', 
                members: [
                    { id: 101, name: "김철수", location: "평창문화로", status: "progress", lat: 37.606, lng: 126.968 },
                    { id: 102, name: "이영희", location: "구기터널 입구", status: "progress", lat: 37.609, lng: 126.958 },
                    { id: 103, name: "박동훈", location: "북악스카이웨이", status: "warning", lat: 37.600, lng: 126.980 }
                ]
            },
            {
                id: 't2', name: '중구_기동_2팀', area: '명동/을지로', 
                members: [
                    { id: 201, name: "박준형", location: "을지로3가", status: "idle", lat: 37.566, lng: 126.992 },
                    { id: 202, name: "최성우", location: "명동성당", status: "idle", lat: 37.563, lng: 126.987 }
                ]
            },
            {
                id: 't3', name: '용산_지원_1팀', area: '이태원/한남', 
                members: [
                    { id: 301, name: "정민재", location: "이태원로", status: "warning", lat: 37.534, lng: 126.994 },
                    { id: 302, name: "강민호", location: "한남대교 북단", status: "completed", lat: 37.528, lng: 127.009 }
                ]
            },
            {
                id: 't4', name: '강남_제설_1팀', area: '테헤란로/역삼',
                members: [
                    { id: 401, name: "이상혁", location: "강남역 사거리", status: "progress", lat: 37.498, lng: 127.027 },
                    { id: 402, name: "배준식", location: "선릉역", status: "progress", lat: 37.504, lng: 127.048 },
                    { id: 403, name: "이재완", location: "역삼역", status: "progress", lat: 37.500, lng: 127.036 }
                ]
            },
            {
                id: 't5', name: '송파_기동_3팀', area: '잠실/석촌',
                members: [
                    { id: 501, name: "김기인", location: "롯데타워 인근", status: "idle", lat: 37.513, lng: 127.102 },
                    { id: 502, name: "손시우", location: "석촌호수", status: "idle", lat: 37.509, lng: 127.104 }
                ]
            },
            {
                id: 't6', name: '서대문_시설_1팀', area: '신촌/연희',
                members: [
                    { id: 601, name: "허수", location: "연세로", status: "completed", lat: 37.559, lng: 126.936 },
                    { id: 602, name: "김건부", location: "연희동 주민센터", status: "progress", lat: 37.566, lng: 126.930 }
                ]
            },
            {
                id: 't7', name: '영등포_제설_2팀', area: '여의도/당산',
                members: [
                    { id: 701, name: "박재혁", location: "여의도 환승센터", status: "progress", lat: 37.525, lng: 126.924 },
                    { id: 702, name: "조용인", location: "국회의사당", status: "warning", lat: 37.531, lng: 126.914 }
                ]
            },
            {
                id: 't8', name: '성북_지원_1팀', area: '성북동/정릉',
                members: [
                    { id: 801, name: "홍창현", location: "성북동 길", status: "warning", lat: 37.595, lng: 126.995 },
                    { id: 802, name: "홍해성", location: "정릉 입구", status: "progress", lat: 37.602, lng: 127.005 }
                ]
            },
            {
                id: 't9', name: '마포_기동_1팀', area: '홍대/합정',
                members: [
                    { id: 901, name: "김혁규", location: "합정역", status: "completed", lat: 37.548, lng: 126.913 },
                    { id: 902, name: "조건희", location: "상수역", status: "completed", lat: 37.547, lng: 126.922 }
                ]
            },
             {
                id: 't10', name: '강동_제설_1팀', area: '천호/길동',
                members: [
                    { id: 1001, name: "정지훈", location: "천호대교 남단", status: "progress", lat: 37.542, lng: 127.117 },
                    { id: 1002, name: "최현준", location: "길동 사거리", status: "progress", lat: 37.537, lng: 127.140 }
                ]
            }
        ];

        function renderTeams() {
            const container = document.getElementById('teamContainer');
            container.innerHTML = teamsData.map(team => `
                <div class="mb-1.5 border border-slate-200 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700/50 overflow-hidden">
                    <button onclick="toggleTeam('${team.id}')" class="w-full flex items-center justify-between p-2 text-[10px] font-bold hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors text-slate-700 dark:text-slate-200">
                        <div class="flex items-center gap-1.5">
                            <i class="fa-solid fa-users-line text-brand-500 text-xs"></i>
                            ${team.name} <span class="font-normal text-slate-400 ml-0.5">(${team.area})</span>
                        </div>
                        <i id="icon-${team.id}" class="fa-solid fa-chevron-down transition-transform text-[9px]"></i>
                    </button>
                    
                    <div id="content-${team.id}" class="team-content max-h-0 bg-white dark:bg-slate-800">
                        <table class="w-full text-left text-[10px]">
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                ${team.members.map(member => {
                                    let statusBadge = '';
                                    if(member.status === 'progress') statusBadge = '<span class="w-1.5 h-1.5 rounded-full bg-blue-500 inline-block mr-1"></span>작업중';
                                    else if(member.status === 'idle') statusBadge = '<span class="w-1.5 h-1.5 rounded-full bg-slate-400 inline-block mr-1"></span>대기';
                                    else if(member.status === 'completed') statusBadge = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500 inline-block mr-1"></span>완료';
                                    else statusBadge = '<span class="w-1.5 h-1.5 rounded-full bg-amber-500 inline-block mr-1"></span>지연';

                                    return `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                            <td class="p-2 pl-3 font-medium dark:text-slate-300">${member.name}</td>
                                            <td class="p-2 text-slate-500 dark:text-slate-400">${statusBadge}</td>
                                            <td class="p-2 text-right pr-3">
                                                <div class="cursor-grab active:cursor-grabbing w-5 h-5 rounded bg-slate-100 dark:bg-slate-600 border border-slate-200 dark:border-slate-500 flex items-center justify-center ml-auto shadow-sm hover:border-brand-500 hover:text-brand-500 transition-colors"
                                                     draggable="true" 
                                                     ondragstart="handleDragStart(event, ${member.id}, '${member.name}')"
                                                     ondragend="handleDragEnd(event)">
                                                    <i class="fa-solid fa-grip-vertical text-[8px]"></i>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }
        renderTeams();

        function toggleTeam(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                icon.style.transform = 'rotate(180deg)';
            }
        }


        // --- 3. Mini Map Integration ---
        const map = L.map('adminMap', { zoomControl: false }).setView([37.5665, 126.9780], 11);
        const lightTile = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        const darkTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        let tileLayer = L.tileLayer(document.documentElement.classList.contains('dark') ? darkTile : lightTile, { maxZoom: 19 }).addTo(map);

        const staffMarkers = {};
        teamsData.forEach(team => {
            team.members.forEach(staff => {
                const color = staff.status === 'idle' ? '#94a3b8' : (staff.status === 'progress' ? '#3b82f6' : (staff.status === 'warning' ? '#F59E0B' : '#10b981'));
                const marker = L.circleMarker([staff.lat, staff.lng], {
                    radius: 6, fillColor: color, color: '#fff', weight: 1, fillOpacity: 1
                }).addTo(map).bindPopup(`<b>${staff.name}</b><br>${team.name}`);
                staffMarkers[staff.id] = marker;
            });
        });


        // --- 4. Drag & Drop Logic (Same as before) ---
        const mapContainer = document.getElementById('adminMap');
        const overlay = document.getElementById('mapDropOverlay');

        function handleDragStart(e, id, name) {
            e.dataTransfer.setData("text/plain", JSON.stringify({id, name}));
            e.dataTransfer.effectAllowed = "copy";
            overlay.classList.remove('hidden');
        }
        function handleDragEnd(e) { overlay.classList.add('hidden'); }
        mapContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; overlay.classList.remove('hidden'); overlay.classList.add('bg-brand-500/30'); });
        mapContainer.addEventListener('dragleave', (e) => { overlay.classList.remove('bg-brand-500/30'); });
        
        mapContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            overlay.classList.add('hidden');
            const data = JSON.parse(e.dataTransfer.getData("text/plain"));
            const mapRect = mapContainer.getBoundingClientRect();
            const point = L.point(e.clientX - mapRect.left, e.clientY - mapRect.top);
            const latlng = map.containerPointToLatLng(point);

            alert(`[작업 할당 완료]\n대상: ${data.name}\n위치: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}\n\n이동 명령이 전송되었습니다.`);
            
            if(staffMarkers[data.id]) {
                staffMarkers[data.id].setLatLng(latlng);
                staffMarkers[data.id].setStyle({ fillColor: '#3b82f6' });
            }
            addNotification(`시스템: ${data.name}님에게 새로운 구역이 할당되었습니다.`, 'info');
        });


        // --- 5. Notifications & Dark Mode ---
        function addNotification(msg, type) {
            const panel = document.getElementById('notificationPanel');
            const time = new Date().toLocaleTimeString('ko-KR', {hour12: false});
            const colorClass = type === 'alert' ? 'text-red-300 bg-red-500/20 border-red-500/30' : 'text-blue-300 bg-blue-500/20 border-blue-500/30';
            const label = type === 'alert' ? '긴급' : '할당';
            const html = `<div class="flex items-start gap-2 text-[10px] p-1.5 hover:bg-white/5 rounded transition-colors animate-pulse"><span class="text-slate-400 font-mono whitespace-nowrap">${time}</span><span class="${colorClass} px-1 py-0.5 rounded text-[9px] border font-bold">${label}</span><span>${msg}</span></div>`;
            panel.insertAdjacentHTML('afterbegin', html);
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            tileLayer.setUrl(html.classList.contains('dark') ? darkTile : lightTile);
        }
        
        setTimeout(() => { addNotification("성북구 정릉동 일대 결빙 신고 접수 증가. 추가 인력 배치가 필요합니다.", "alert"); }, 10000);

    </script>
</body>
</html>